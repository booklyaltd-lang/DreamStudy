# Настройка CloudPayments

Это руководство поможет вам интегрировать платежную систему CloudPayments в ваше приложение.

## Шаг 1: Регистрация в CloudPayments

1. Перейдите на [cloudpayments.ru](https://cloudpayments.ru/)
2. Зарегистрируйте аккаунт или войдите, если у вас уже есть аккаунт
3. Создайте сайт в личном кабинете
4. Пройдите модерацию (обычно занимает 1-3 дня)

## Шаг 2: Получение API ключей

1. В личном кабинете CloudPayments перейдите в раздел **Сайты**
2. Выберите ваш сайт
3. Найдите и скопируйте:
   - **Public ID** - публичный идентификатор для виджета
   - **Пароль для API** (API Secret) - секретный ключ для серверных запросов

## Шаг 3: Настройка в админ-панели приложения

1. Войдите в админ-панель вашего приложения
2. Перейдите в раздел **Финансы**
3. В разделе "Платежные системы":
   - Включите CloudPayments
   - Выберите CloudPayments как основную систему
   - Введите **Public ID**
   - Введите **Пароль для API**
4. Сохраните настройки

## Шаг 4: Настройка Webhook в CloudPayments (КРИТИЧЕСКИ ВАЖНО!)

**Без настройки webhook платежи НЕ БУДУТ обрабатываться автоматически!**

Webhook необходим для получения уведомлений о статусе платежей от CloudPayments.

### Настройка в личном кабинете CloudPayments:

1. В личном кабинете CloudPayments перейдите в раздел **Сайты**
2. Выберите ваш сайт
3. Перейдите на вкладку **Уведомления**
4. Найдите секцию **Pay** (для разовых платежей)
5. Включите переключатель для уведомлений **Pay**
6. В поле **Адрес** укажите:
   ```
   https://ваш-проект.supabase.co/functions/v1/cloudpayments-webhook
   ```

   **Пример:**
   ```
   https://mpblcwwkhjbldrgmkfra.supabase.co/functions/v1/cloudpayments-webhook
   ```

7. Установите параметры:
   - **Кодировка**: UTF-8
   - **HTTP метод**: POST
   - **Формат**: CloudPayments

8. Если вы также планируете использовать подписки, повторите настройку для секции **Recurrent**

9. Сохраните настройки

### Как найти URL вашего проекта

URL вашего проекта Supabase можно найти:
- В файле `.env` проекта (переменная `VITE_SUPABASE_URL`)
- В Supabase Dashboard → Project Settings → API
- В формате: `https://[project-ref].supabase.co`

### Проверка webhook

После настройки webhook вы можете проверить его работу:

1. Откройте Supabase Dashboard
2. Перейдите в **Edge Functions → cloudpayments-webhook**
3. Откройте **Logs**
4. Совершите тестовый платеж
5. В логах должны появиться записи о получении уведомления от CloudPayments

## Шаг 5: Тестирование интеграции

### Тестовый режим

CloudPayments предоставляет тестовый режим для проверки интеграции:

1. В личном кабинете убедитесь, что тестовый режим включен
2. Используйте тестовые карты для проверки платежей:
   - Успешный платеж: `4111 1111 1111 1111`
   - CVV: любые 3 цифры
   - Срок действия: любая будущая дата (например, 12/25)
   - Имя держателя: любое имя

### Проверка платежей в приложении

1. Перейдите на страницу с тарифами или курсами
2. Нажмите кнопку "Оплатить"
3. В открывшемся виджете CloudPayments введите данные тестовой карты
4. Нажмите "Оплатить"
5. После успешной оплаты:
   - CloudPayments отправит уведомление на ваш webhook
   - Статус платежа обновится в базе данных
   - Пользователю будет предоставлена подписка или доступ к курсу
   - Пользователь будет перенаправлен на страницу успеха
6. Проверьте в профиле, что доступ активирован

## Структура базы данных

Платежи сохраняются в таблице `payments`:

```sql
- yookassa_payment_id: ID платежа (используется как InvoiceId для CloudPayments)
- user_id: ID пользователя
- amount: Сумма платежа
- currency: Валюта (RUB)
- status: Статус (pending, succeeded, failed)
- payment_type: Тип (subscription, course)
- subscription_id: ID подписки (если применимо)
- course_id: ID курса (если применимо)
- metadata: Дополнительные данные (тип провайдера, информация о карте)
```

## Как работает процесс оплаты

1. **Инициализация платежа**: Пользователь нажимает кнопку "Оплатить"
2. **Создание платежа**: Edge Function `create-payment` создает запись в БД
3. **Открытие виджета**: На странице открывается виджет CloudPayments
4. **Оплата**: Пользователь вводит данные карты и оплачивает
5. **Callback от виджета**: После успешной оплаты виджет вызывает `confirm-payment`
6. **Webhook от CloudPayments**: CloudPayments отправляет уведомление на webhook
7. **Обработка**: Webhook обновляет статус платежа и создает подписку/покупку курса
8. **Доступ**: Пользователь получает доступ к контенту

## Два пути обработки платежей

Система использует два механизма для надежности:

### 1. Webhook (основной путь)
- CloudPayments автоматически отправляет уведомление после обработки платежа
- Самый надежный способ
- **Требует обязательной настройки в личном кабинете CloudPayments**

### 2. Confirm Payment (резервный путь)
- Вызывается с фронтенда после успешной оплаты в виджете
- Работает как резервный механизм на случай проблем с webhook
- Пользователь может вручную подтвердить платеж в профиле

## Отладка проблем

### Платежи создаются, но подписка/курс не активируется

**Это самая частая проблема!** Причина: webhook не настроен или настроен неправильно.

**Решение:**
1. Проверьте, что webhook настроен в личном кабинете CloudPayments
2. Убедитесь, что URL webhook правильный (см. Шаг 4)
3. Проверьте логи Edge Function в Supabase Dashboard
4. Совершите тестовый платеж и проверьте, приходит ли уведомление

### Проверка логов webhook

1. Откройте Supabase Dashboard
2. Перейдите в **Edge Functions → cloudpayments-webhook → Logs**
3. После совершения платежа в логах должна появиться запись:
   ```
   CloudPayments webhook received: {
     TransactionId: xxxxx,
     InvoiceId: 'uuid',
     Status: 'Completed',
     Amount: 1000
   }
   ```
4. Если логов нет - webhook не настроен или настроен неправильно

### Виджет оплаты не открывается

- Убедитесь, что Public ID введен правильно в настройках
- Проверьте консоль браузера на наличие ошибок
- Попробуйте обновить страницу

### Ошибка "Платежная система не настроена"

- Убедитесь, что в админ-панели включен CloudPayments
- Проверьте, что введены Public ID и Пароль для API
- Проверьте, что выбран CloudPayments как основная система

### Платеж успешный, но пользователь не видит доступ

1. Проверьте таблицу `payments` в базе данных:
   - Статус должен быть `succeeded`

2. Если статус `pending`:
   - Webhook не работает (см. выше)
   - Пользователь может вручную подтвердить платеж в профиле

3. Проверьте таблицу `user_subscriptions` (для подписок):
   - Должна быть запись с `is_active = true`
   - `end_date` должна быть в будущем

4. Проверьте таблицу `course_purchases` (для курсов):
   - Должна быть запись с соответствующим `course_id`

5. Проверьте таблицу `profiles`:
   - `subscription_tier` должен быть обновлен (для подписок)
   - `subscription_expires_at` должна быть в будущем

### Тестовая карта не работает

- Убедитесь, что используете правильный номер: `4111 1111 1111 1111`
- Проверьте, что тестовый режим включен в личном кабинете CloudPayments
- Попробуйте другую тестовую карту из документации CloudPayments

## Переход в production

Когда вы будете готовы принимать реальные платежи:

1. Пройдите полную модерацию в CloudPayments
2. Переключите сайт из тестового режима в боевой
3. Убедитесь, что webhook настроен на production URL
4. Проведите несколько тестовых платежей на минимальную сумму (1 рубль)
5. Мониторьте логи первые несколько дней
6. Проверьте, что все платежи обрабатываются корректно

## Комиссии

CloudPayments взимает комиссию с каждого платежа. Размер комиссии зависит от:
- Вашего тарифного плана
- Объема платежей
- Способа оплаты (карта, электронный кошелек и т.д.)

Актуальную информацию о комиссиях смотрите в [документации CloudPayments](https://cloudpayments.ru/docs/Tariffs).

## Полезные ссылки

- [Документация API CloudPayments](https://developers.cloudpayments.ru/)
- [Личный кабинет CloudPayments](https://merchant.cloudpayments.ru/)
- [Виджет оплаты](https://developers.cloudpayments.ru/#skachat-widget)
- [Настройка уведомлений](https://developers.cloudpayments.ru/#uvedomleniya)
- [Тестовые карты](https://developers.cloudpayments.ru/#testirovanie)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

## Безопасность

- **Никогда не передавайте API Secret на фронтенд**
- Public ID можно использовать публично (он предназначен для виджета)
- Все серверные операции выполняются через Edge Functions
- Webhook защищен от подделки через проверку подписи (если настроена)

## Поддержка

Если у вас возникли проблемы:
- CloudPayments: support@cloudpayments.ru
- Документация: https://developers.cloudpayments.ru/
- Telegram поддержка: @cloudpayments_support

## Часто задаваемые вопросы

### Можно ли использовать CloudPayments и YooKassa одновременно?

Да, система поддерживает переключение между провайдерами. Выберите основную систему в админ-панели.

### Как настроить подписки (рекуррентные платежи)?

CloudPayments поддерживает подписки. Настройте webhook для секции **Recurrent** аналогично настройке для **Pay**.

### Что делать, если webhook внезапно перестал работать?

1. Проверьте статус Edge Function в Supabase Dashboard
2. Проверьте, что URL webhook не изменился
3. Проверьте логи на наличие ошибок
4. Убедитесь, что CloudPayments не заблокировал ваш webhook из-за ошибок

### Можно ли принимать платежи в других валютах?

Да, CloudPayments поддерживает несколько валют. Измените валюту в настройках создания платежа.

### Как сделать возврат платежа?

Возврат оформляется через личный кабинет CloudPayments. После возврата система автоматически получит уведомление через webhook.
