# Настройка YooKassa (Яндекс Пэй)

Это руководство поможет вам интегрировать платежную систему YooKassa в ваше приложение.

## Шаг 1: Регистрация в YooKassa

1. Перейдите на [yookassa.ru](https://yookassa.ru/)
2. Зарегистрируйте аккаунт или войдите, если у вас уже есть аккаунт
3. Создайте магазин в личном кабинете
4. Пройдите модерацию (обычно занимает 1-3 дня)

## Шаг 2: Получение API ключей

1. В личном кабинете YooKassa перейдите в раздел **Настройки → Технические параметры**
2. Найдите и скопируйте:
   - **shopId** (Идентификатор магазина)
   - **Секретный ключ** (Secret Key)

## Шаг 3: Настройка переменных окружения в Supabase

### В локальном окружении

Если вы разрабатываете локально, добавьте переменные в файл `.env`:

```env
YOOKASSA_SHOP_ID=ваш_shop_id
YOOKASSA_SECRET_KEY=ваш_секретный_ключ
```

### В production окружении (Supabase)

1. Откройте проект в [Supabase Dashboard](https://app.supabase.com/)
2. Перейдите в **Project Settings → Edge Functions**
3. В разделе **Secrets** добавьте следующие переменные:
   - Имя: `YOOKASSA_SHOP_ID`, Значение: ваш shopId
   - Имя: `YOOKASSA_SECRET_KEY`, Значение: ваш секретный ключ

## Шаг 4: Настройка Webhook в YooKassa

Webhook необходим для получения уведомлений о статусе платежей.

1. В личном кабинете YooKassa перейдите в **Настройки → Уведомления**
2. Включите HTTP-уведомления
3. В поле **URL для уведомлений** укажите:
   ```
   https://ваш-проект.supabase.co/functions/v1/yookassa-webhook
   ```
4. Выберите события для отправки уведомлений:
   - ✅ `payment.succeeded` - успешный платеж
   - ✅ `payment.canceled` - отмененный платеж
5. Сохраните настройки

## Шаг 5: Тестирование интеграции

### Тестовый режим

YooKassa предоставляет тестовый режим для проверки интеграции:

1. В личном кабинете переключите магазин в **тестовый режим**
2. Используйте тестовые карты для проверки платежей:
   - Успешный платеж: `5555 5555 5555 4477`
   - CVV: любые 3 цифры
   - Срок действия: любая будущая дата

### Проверка платежей в приложении

1. Перейдите на страницу с тарифами или курсами
2. Нажмите кнопку "Оплатить"
3. Вы будете перенаправлены на страницу оплаты YooKassa
4. Введите данные тестовой карты
5. После успешной оплаты вы будете перенаправлены на страницу успеха
6. Проверьте в админ-панели, что платеж записан в базу данных

## Структура базы данных

Платежи сохраняются в таблице `payments`:

```sql
- yookassa_payment_id: ID платежа от YooKassa
- user_id: ID пользователя
- amount: Сумма платежа
- currency: Валюта (RUB)
- status: Статус (pending, succeeded, canceled)
- payment_type: Тип (subscription, course)
- subscription_id: ID подписки (если применимо)
- course_id: ID курса (если применимо)
```

## Как работает процесс оплаты

1. **Инициализация платежа**: Пользователь нажимает кнопку "Оплатить"
2. **Создание платежа**: Edge Function `create-payment` создает платеж в YooKassa
3. **Перенаправление**: Пользователь перенаправляется на страницу оплаты YooKassa
4. **Оплата**: Пользователь вводит данные карты и оплачивает
5. **Возврат**: Пользователь возвращается на сайт на страницу `/payment-success`
6. **Webhook**: YooKassa отправляет уведомление на `/functions/v1/yookassa-webhook`
7. **Обработка**: Webhook обновляет статус платежа и создает подписку/покупку курса
8. **Доступ**: Пользователь получает доступ к контенту

## Отладка проблем

### Платежи не создаются

- Проверьте, что переменные окружения `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY` установлены
- Проверьте логи Edge Function в Supabase Dashboard
- Убедитесь, что shopId и секретный ключ корректны

### Webhook не работает

- Проверьте URL webhook в настройках YooKassa
- Убедитесь, что Edge Function `yookassa-webhook` развернута
- Проверьте логи webhook в Supabase Dashboard
- Проверьте, что в YooKassa включены нужные события

### Платеж создан, но доступ не предоставлен

- Проверьте таблицу `payments` в базе данных
- Убедитесь, что статус платежа изменился на `succeeded`
- Проверьте таблицы `user_subscriptions` или `course_purchases`
- Проверьте логи webhook для ошибок обработки

## Переход в production

Когда вы будете готовы принимать реальные платежи:

1. Пройдите полную модерацию в YooKassa
2. Переключите магазин из тестового режима в боевой
3. Обновите webhook URL на production URL
4. Проведите несколько тестовых платежей на минимальную сумму
5. Мониторьте логи первые несколько дней

## Комиссии

YooKassa взимает комиссию с каждого платежа. Размер комиссии зависит от:
- Вашего тарифного плана
- Объема платежей
- Способа оплаты (карта, электронный кошелек и т.д.)

Актуальную информацию о комиссиях смотрите в [документации YooKassa](https://yookassa.ru/fees/).

## Полезные ссылки

- [Документация API YooKassa](https://yookassa.ru/developers/api)
- [Личный кабинет YooKassa](https://yookassa.ru/my)
- [Тестовые данные](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

## Поддержка

Если у вас возникли проблемы:
- YooKassa: support@yookassa.ru
- Документация: https://yookassa.ru/developers/
